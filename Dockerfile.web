FROM node:bullseye

WORKDIR /home/node/app
COPY src/web/public ./public
COPY src/web/src ./src
COPY src/web/package.json ./
COPY src/web/yarn.lock ./
COPY src/web/tsconfig.json ./
COPY src/web/next-env.d.ts ./
COPY src/web/next.config.js ./

RUN yarn install --non-interactive --immutable

ARG NEXT_PUBLIC_API_ENDPOINT
ENV NEXT_PUBLIC_API_ENDPOINT=${NEXT_PUBLIC_API_ENDPOINT}
ARG NEXT_PUBLIC_APP_DESCRIPTION
ENV NEXT_PUBLIC_APP_DESCRIPTION=${NEXT_PUBLIC_APP_DESCRIPTION}
ARG NEXT_PUBLIC_APP_NAME
ENV NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME}
ARG NEXT_PUBLIC_BASE_DOMAIN
ENV NEXT_PUBLIC_BASE_DOMAIN=${NEXT_PUBLIC_BASE_DOMAIN}
ARG NEXT_PUBLIC_BASE_URL
ENV NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL}
ARG NEXT_PUBLIC_ENVIRONMENT
ENV NEXT_PUBLIC_ENVIRONMENT=${NEXT_PUBLIC_ENVIRONMENT}
ARG NEXT_PUBLIC_GOOGLE_MEASUREMENT_ID
ENV NEXT_PUBLIC_GOOGLE_MEASUREMENT_ID=${NEXT_PUBLIC_GOOGLE_MEASUREMENT_ID}

RUN echo > .env
RUN echo NEXT_PUBLIC_API_ENDPOINT=\"${NEXT_PUBLIC_API_ENDPOINT}\" >> .env
RUN echo NEXT_PUBLIC_APP_DESCRIPTION=\"${NEXT_PUBLIC_APP_DESCRIPTION}\" >> .env
RUN echo NEXT_PUBLIC_APP_NAME=\"${NEXT_PUBLIC_APP_NAME}\" >> .env
RUN echo NEXT_PUBLIC_BASE_DOMAIN=\"${NEXT_PUBLIC_BASE_DOMAIN}\" >> .env
RUN echo NEXT_PUBLIC_BASE_URL=\"${NEXT_PUBLIC_BASE_URL}\" >> .env
RUN echo NEXT_PUBLIC_ENVIRONMENT=\"${NEXT_PUBLIC_ENVIRONMENT}\" >> .env
RUN echo NEXT_PUBLIC_GOOGLE_MEASUREMENT_ID=\"${NEXT_PUBLIC_GOOGLE_MEASUREMENT_ID}\" >> .env

ENV NODE_ENV=production

RUN yarn build
CMD yarn start
